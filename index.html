<!-- Import the component -->
<script type="module" src="model-viewer.js"></script>
<style>
    model-viewer{
        width: 100%;
        height : 500px;
    }
</style>
<!-- Use it like any other HTML element -->
        <video id="video-texture" style="display:none;" autoplay muted loop playsinline 
               src="./Dior-Jadore5th_916_LQ.mp4"
               onerror="this.onerror=null;this.src='https://placehold.co/1280x720/000000/FFFFFF?text=Video+Error';">
        </video>
<model-viewer id="viewer" src="./ModelMupiSolidBase.glb" ar alt="A 3D model of a duck" camera-controls background-color="#455A64">             
</model-viewer>
    <script type="module">
        // Attend que la page soit entièrement chargée
        window.addEventListener('load', () => {
            
            const modelViewer = document.querySelector('#viewer');
            const video = document.querySelector('#video-texture');

            if (!video) {
                console.error("ERREUR CRITIQUE : L'élément vidéo avec l'ID '#video-texture' n'a pas été trouvé.");
                return;
            }

            // Ajout d'un écouteur d'erreur pour le modèle 3D, très utile pour le débogage.
            modelViewer.addEventListener('error', (event) => {
                console.error('Erreur de chargement du modèle 3D:', event.detail);
            });

            const applyVideoTexture = async () => {
                console.log("Application de la texture via un canvas.");

                try {
                    // --- APPROCHE CANVAS (la plus stable) ---

                    // 1. Créer un élément canvas en mémoire
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');

                    // 2. Définir la taille du canvas pour correspondre à la vidéo
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;

                    // 3. Créer la texture à partir du canvas
                    const texture = await modelViewer.createTexture(canvas);

                    // 4. Appliquer la texture au matériel
                    const material = modelViewer.model.materials.find(m => m.name === 'Screen');
                    
                    if (material) {
                        console.log("Matériel trouvé:", material.name);
                        material.pbrMetallicRoughness.setBaseColorTexture(texture);
                        material.setEmissiveTexture(texture);
                        console.log("Texture (depuis canvas) appliquée au matériel.");
                    } else {
                        console.warn("Le matériel cible n'a pas été trouvé.");
                        return;
                    }

                    // 5. Démarrer une boucle pour dessiner la vidéo sur le canvas en continu
                    const updateCanvas = () => {
                        if (video.paused || video.ended) {
                            return;
                        }
                        context.drawImage(video, 0, 0, canvas.width, canvas.height);
                        requestAnimationFrame(updateCanvas);
                    };
                    requestAnimationFrame(updateCanvas);

                } catch (error) {
                    console.error("Erreur lors de la création ou de l'application de la texture via le canvas :", error);
                }
            };

            // --- NOUVELLE LOGIQUE DE DÉMARRAGE (plus robuste) ---
            const videoPlayPromise = video.play();

            if (videoPlayPromise !== undefined) {
                // On attend que le modèle soit chargé ET que la vidéo ait commencé à jouer.
                Promise.all([modelViewer.loaded, videoPlayPromise])
                    .then(() => {
                        console.log("Le modèle est chargé ET la vidéo a commencé à jouer.");
                        applyVideoTexture();
                    })
                    .catch(error => {
                        console.error("Une erreur est survenue lors du chargement du modèle ou de la vidéo:", error);
                    });
            } else {
                console.warn("Le navigateur ne supporte pas la promesse de video.play().");
            }
        });
    </script>
                <button slot="ar-button" style="background-color: white; border-radius: 4px; border: solid blue; position: absolute; top: 16px; right: 16px; ">Activate AR</button>